<!DOCTYPE html>
<head>
<meta charset="utf-8">

<link rel="manifest" href="/manifest.json">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="application-name" content="R2W">
<meta name="apple-mobile-web-app-title" content="R2W">
<meta name="theme-color" content="#f80">
<meta name="msapplication-navbutton-color" content="#f80">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="msapplication-starturl" content="/">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<title>R2W user</title>
<link rel="stylesheet" href="/V2/css/jquery-ui.min.css">
<link rel="stylesheet" href="/V2/css/styles.css">
<style>

.submit_container{display:block}
.dev{
  display:block;
}

div[class^="mobile-"]{
    display:none;
}


/* MOBILE */
@media only screen and (max-width: 600px) {
    div[class^="mobile-"]{
        display:block;
    }
}
/* TABLET */


.mobile-nav{
  background: #888;
  width:100vw;
  overflow: hidden;
  position: fixed;
}

/* Hide the links inside the navigation menu (except for logo/home) */
.mobile-nav #myLinks {
  display: none;
}

/* Style navigation menu links */
.mobile-nav a {
  color: #fff;
  padding: 14px 14px;
  text-decoration: none;
  font-size: 1rem;
  display: block;
}

/* Style the hamburger menu */
.mobile-nav a.icon {
  background: #555;
  display: block;
  position: absolute;
  right: 0;
  top: 0;
}

/* Add a grey background color on mouse-over */
.mobile-nav a:hover {
  background-color: #888;
  color: #fff;
}

/* Style the active link (or home/logo) */
.active {
  background-color: #555;
  color: white;
}


</style>

<script src="/V2/js/jquery.min.js"></script>
<script src="/V2/js/R2W.js"></script>
<script src="/V2/js/jquery-ui.min.js"></script>
<script src="/V2/js/underscore-min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


</head>
<body>

<div class="mobile-nav">
  <!-- Top Navigation Menu -->
    <a href="#home" class="active pagelink">
    <!--<img src="/V2/images/R2Wlogo.svg" height="10px">-->
    R2W
    </a>
    <!-- Navigation links (hidden by default) -->
    <div id="myLinks">
      <a href="#news" class="pagelink">Add Case</a>
      <a href="#contact" class="pagelink">List Cases</a>
      <a href="#logout" class="pagelink">Logout</a>
    </div>
    <!-- "Hamburger menu" / "Bar icon" to toggle the navigation links -->
    <a href="javascript:applinks();" class="icon">
      <i class="fa fa-bars"></i>
    </a>
</div>
<script>
function applinks() {
/*
  var x = document.getElementById("myLinks");
  if (x.style.display === "block") {
    x.style.display = "none";
  } else {
    x.style.display = "block";
  }*/
  $("#myLinks").toggle();
}
$(".mobile-nav .pagelink").on("click",function(e){
  //console.log($(e.target).hasClass('icon'));
  $("#myLinks").hide();

});

</script>


<div class="mobile-spacer">
<br><br>
</div>

<div class="paper">
  <h1>R2W / Editor portal</h1>
  <b><%= user; %></b> logged in as <b><%= role; %></b>
  


    <div class="panel">
        <h2>Add Case</h2>
        <div id="new_case" class="FForm">Loading...</div>
        
        <div class="submit_container">
            <span id="update_case_status"></span>
            <button onclick="new_case()">Add</button>
        </div>
    </div>



    <div class="panel">
      <h2>Case list</h2>
      
             <div>
              Filter cases by caseID: (e.g. FNIDN* OR EXIDN* OR PHS*)<br>
              <input type="text" id="q" onchange="search()" value="*" style="width:calc(100% - 100px)"> 
                <button onclick="search()" style="width:95px">Filter</button>
                
                
            </div>
              <div id="cases_status">&nbsp;</div>
      <div id="cases"></div>
      <br>
      <div id="cases_pagination"></div>
      
    </div>
</div>


<br><br>

<script>
//new case
function new_case(){
  var url = `/api/v1/cases/createcase`;
  var id = $("#new_case #caseID").val();
  if (id){
      data = {caseID: id }
      jqxhr = post(url,data,inspectJSON);
      //post("/api/v1/cases/createcase",{caseID: 'test'},function(d){console.log(d)});
  }else{
     $("#update_case_status").html("enter case reference");
  }
}
function check_duplicate_caseid(){
    var id = $("#new_case #caseID").val();
    if(id){
        var url = `/api/v1/cases/caseexists/${id}`;
        jqxhr = get(url,show_duplicate_caseid);
    }
}
function show_duplicate_caseid(data){
    if (Number(data) == 0){
        $("#update_case_status").html("");
    }else{
        $("#update_case_status").html("caseID already exists");
    }
}

function caseexists(){
    var id = $("#newcaseid").val();
    if(id){
        var url = `/api/v1/cases/caseexists/${id}`;
        jqxhr = get(url,inspectJSON);
    }else{
        $("#newcaseid").focus()
    }
}
function inspectJSON(d){
    if (d.status){
      console.log(d)
      $("#update_case_status").html(`${d.message}: <a href="/view/case/${d.data}">${d.data}</a>`);

      search();

    }else{
      $("#update_case_status").html(`${d.message}`)
    }
    
    
}

//////////////////////////////////////////
function init_form(){
    var manage_form = makeform({},[
        {key:"caseID",label:"Case ID",type:"text",placeholder:"Case Reference"},
    ])
    $("#new_case").html(manage_form);
    
    $("#new_case_btn").show()
    
    $("#new_case #caseID").on('change', function(d){
        check_duplicate_caseid()
        console.log("check");
    })
    
}
init_form();
</script>




<script>

/////////// client-side table sort
function init_table_sort(){
  $('th').click(function(){
      var table = $(this).parents('table').eq(0)
      var rows = table.find('tr:gt(0)').toArray().sort(comparer($(this).index()))
      this.asc = !this.asc
      if (!this.asc){rows = rows.reverse()}
      for (var i = 0; i < rows.length; i++){table.append(rows[i])}
  })
  function comparer(index) {
      return function(a, b) {
          var valA = getCellValue(a, index), valB = getCellValue(b, index)
          return $.isNumeric(valA) && $.isNumeric(valB) ? valA - valB : valA.toString().localeCompare(valB)
      }
  }
  function getCellValue(row, index){ return $(row).children('td').eq(index).text() }
}


////////////////////////////////////////////

    function search(){
      //post("/api/v1/cases/search/",{q:$("#q").val()},_search)
      
      //$("#cases").html("Loading..."); //replace this with a skeleton table
      $("#cases").html(`
      <table class=skeleton>
      <tr><th><span>000000</span></th><th><span>00000</span></th><th><span>00000</span></th></tr>
      <tr><td><span>0000</span></td><td><span>000</span></td><td><span>00</span></td></tr>
      <tr><td><span>000</span></td><td><span>0000</span></td><td><span>000</span></td></tr>
      <tr><td><span>0000</span></td><td><span>000</span></td><td><span>0</span></td></tr>
      </table>
      
      `); //replace this with a skeleton table
 
      show_cases_summary(0);
      show_pagination();
    }


//////////////////////////////////////////
//pagintion
var state = {
  page: 0,
  order: "total"
}
function show_cases_summary(page){

  $("#cases_status").html("loading...")

  state.page = page;
  var url = `/api/v1/cases/getcases/summary/${state.page}/${state.order}/<%= user; %>`;
  jqxhr = post(url,{q:$("#q").val()},_show_cases_summary);
}
function show_pagination(){
  var url = `/api/v1/cases/getcases/summary/total/<%= user; %>`;
  jqxhr = post(url,{q:$("#q").val()},_show_pagination);
}

/////////////////////// superceded
function show_cases_summarySS(page){
  state.page = page;
  var url = `/api/v1/cases/getcases/summary/${state.page}/${state.order}`;
  jqxhr = get(url,_show_cases_summary);
}
function show_paginationSS(){
  var url = `/api/v1/cases/getcases/summary/total`;
  jqxhr = get(url,_show_pagination);
}
///////////////////////

function _show_pagination(total){
  var items_per_page = 10;
  var total_pages = 1;
  var htmlStr = "Page ";
  
  console.log(total)
  if (total>0){
    total_pages = Math.ceil(Number(total)/items_per_page);
  }
  
  
  for (var i = 0; i < total_pages; i++){
    htmlStr += `<button id="page-${i}" onclick="show_cases_summary(${i})">${i+1}</button>`
  }
  
  $("#cases_pagination").html(htmlStr);
  $(`#cases_pagination button#page-0`).addClass("current");
}
function _show_cases_summary(data){
  console.log(data);
  //json out
  var htmlStr = ""
  $.each(data, function(i,d){
    htmlStr += JSON.stringify(d);
    htmlStr += "<br>";
  });
  $("#cases_debug").html(htmlStr);
  
  //table
  
  
  if (data.length){
    var tableStr = "<table>"
    //get header assume keys for one applies to the rest
    var header = Object.keys(data[0]);
    tableStr += "<tr>";
    $.each(header, function(i,d){
      if (d == "editor" || d == "caseID"){
        tableStr += "<th class=adjust>";
      }else{
        tableStr += "<th>";
      }
      tableStr += `<span onclick="state.order='${d}';state.order='${d}';show_cases_summary(0)" class="sortBtn">`
      tableStr += d;
      tableStr += ` <img src="/V2/images/down.png" width="20" align="top"></span>`; //need some thoughts on this one
      tableStr += "</th>";
    });
      //additional columns per row of data
      
 
    tableStr += "</tr>";
    
    $.each(data, function(i,d){
      tableStr += "<tr>";
      $.each(d, function(key,val){
        tableStr += "<td>";
        //custom per key
        if (key == "caseID"){
          tableStr += `<a href="/view/case/${val}">${val}</a>`
        }
        else{
          tableStr += `${val}`
        }
         tableStr += "</td>";
      });
      
      //additional columns per row of data



      
      
      tableStr += "</tr>";
    });
  


    $("#cases").html(tableStr);
  }else{
    $("#cases").html("no records");
  }
  
  //update status message
  $("#cases_status").html("&nbsp;")
  
  //update the pagation class
    $("#cases_pagination button").removeClass("current");
    $(`#cases_pagination button#page-${state.page}`).addClass("current");
}

//show_cases_summary(0);
//show_pagination();

search();
</script>

</body>
</html>



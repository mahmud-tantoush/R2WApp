<!DOCTYPE html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=yes">
<title>R2W user</title>
<link rel="stylesheet" href="/V2/css/jquery-ui.min.css">
<link rel="stylesheet" href="/V2/css/styles.css">
<style>

.submit_container{display:block}
.dev{
  display:block;
}

</style>

<script src="/V2/js/jquery.min.js"></script>
<script src="/V2/js/R2W.js"></script>
<script src="/V2/js/jquery-ui.min.js"></script>
<script src="/V2/js/underscore-min.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

</head>
<body>



<!-- Mobile Top Navigation Menu -->
<div class="block"></div>

<div class="mobile-nav">
    <a href="/" class="active pagelink" onclick="$('.panel').hide();$('#intro').show();">
    <img src="/V2/images/R2Wlogo.svg" height="18px" align="top">
    &nbsp;
    R2W 
    </a>
    <!-- Navigation links -->
    <div id="myLinks">
      <a href="#add_case" class="pagelink" onclick="setPage('#add_case');">Add Case</a>
      <a href="#list_case" class="pagelink" onclick="setPage('#list_case');">List Editor's Cases</a>
      <a href="/overview" class="pagelink">Overview</a>
      <a href="#" class="pagelink" onclick="logout()">Logout</a>
    </div>
    <!-- "Hamburger menu" / "Bar icon" to toggle the navigation links -->
    <a href="javascript:applinks();" class="icon">
      <i class="fa fa-bars"></i>
    </a>
</div>
<div class="mobile-spacer">
<br><br>
</div>

<!-- Mobile Top Navigation Menu -->


<div class="paper">

  <div class="panel" id="intro">
    <h1>R2W / Editor portal</h1>
    <b><%= user; %></b> logged in as <b><%= role; %></b>
    <p>
    See <a href="/overview">Overview</a> for metrics and insights across all records

    
  </div>
  
  <div class="panel" id="note">
<pre>
<h2>Technical notes</h2>
Editor only portal only showing important information for day to day editor purposes

Editor can add a new case, the new case will be associated with the user.
The Case list displays only cases with the username as the named person for editing the case.
It is also important for editor to view other cases (but not editing) assessed via <a href="/overview">overview</a>. 

</pre>
</div>


    <div class="panel" id="add_case">
        <h2>Add Case</h2>
        <div id="new_case" class="FForm">Loading...</div>
        
        <div class="submit_container">
            <span id="update_case_status"></span>
            <button onclick="new_case()">Add</button>
        </div>
    </div>



    <div class="panel" id="list_case">
      <h2>Editor's Cases</h2>
      
             <div>
              Filter cases by caseID: (e.g. FNIDN* OR EXIDN* OR PHS*)<br>
              <input type="text" id="q" onchange="search()" value="*" style="width:calc(100% - 100px)"> 
                <button onclick="search()" style="width:95px">Filter</button>
                
                
            </div>
              <div id="cases_status">&nbsp;</div>
      <div id="cases"></div>
      <br>
      <div id="cases_pagination"></div>
      
    </div>
</div>


<br><br>

<script>
//new case
function new_case(){
  var url = `/api/v1/cases/createcase`;
  var id = $("#new_case #caseID").val();
  if (id){
      data = {caseID: id }
      jqxhr = post(url,data,inspectJSON);
      //post("/api/v1/cases/createcase",{caseID: 'test'},function(d){console.log(d)});
  }else{
     $("#update_case_status").html("enter case reference");
  }
}
function check_duplicate_caseid(){
    var id = $("#new_case #caseID").val();
    if(id){
        var url = `/api/v1/cases/caseexists/${id}`;
        jqxhr = get(url,show_duplicate_caseid);
    }
}
function show_duplicate_caseid(data){
    if (Number(data) == 0){
        $("#update_case_status").html("");
    }else{
        $("#update_case_status").html("caseID already exists");
    }
}

function caseexists(){
    var id = $("#newcaseid").val();
    if(id){
        var url = `/api/v1/cases/caseexists/${id}`;
        jqxhr = get(url,inspectJSON);
    }else{
        $("#newcaseid").focus()
    }
}
function inspectJSON(d){
    if (d.status){
      console.log(d)
      $("#update_case_status").html(`${d.message}: <a href="/view/case/${d.data}">${d.data}</a>`);

      search();

    }else{
      $("#update_case_status").html(`${d.message}`)
    }
    
    
}

//////////////////////////////////////////
function init_form(){
    var manage_form = makeform({},[
        {key:"caseID",label:"Case ID",type:"text",placeholder:"Case Reference"},
    ])
    $("#new_case").html(manage_form);
    
    $("#new_case_btn").show()
    
    $("#new_case #caseID").on('change', function(d){
        check_duplicate_caseid()
        console.log("check");
    })
    
}
init_form();
</script>




<script>

/////////// client-side table sort
function init_table_sort(){
  $('th').click(function(){
      var table = $(this).parents('table').eq(0)
      var rows = table.find('tr:gt(0)').toArray().sort(comparer($(this).index()))
      this.asc = !this.asc
      if (!this.asc){rows = rows.reverse()}
      for (var i = 0; i < rows.length; i++){table.append(rows[i])}
  })
  function comparer(index) {
      return function(a, b) {
          var valA = getCellValue(a, index), valB = getCellValue(b, index)
          return $.isNumeric(valA) && $.isNumeric(valB) ? valA - valB : valA.toString().localeCompare(valB)
      }
  }
  function getCellValue(row, index){ return $(row).children('td').eq(index).text() }
}


////////////////////////////////////////////

    function search(){
      //post("/api/v1/cases/search/",{q:$("#q").val()},_search)
      
      //$("#cases").html("Loading..."); //replace this with a skeleton table
      $("#cases").html(`
      <table class=skeleton>
      <tr><th><span>000000</span></th><th><span>00000</span></th><th><span>00000</span></th></tr>
      <tr><td><span>0000</span></td><td><span>000</span></td><td><span>00</span></td></tr>
      <tr><td><span>000</span></td><td><span>0000</span></td><td><span>000</span></td></tr>
      <tr><td><span>0000</span></td><td><span>000</span></td><td><span>0</span></td></tr>
      </table>
      
      `); //replace this with a skeleton table
 
      show_cases_summary(0);
      show_pagination();
    }


//////////////////////////////////////////
//pagintion
var state = {
  page: 0,
  order: "total"
}
function show_cases_summary(page){

  $("#cases_status").html("loading...")

  state.page = page;
  var url = `/api/v1/cases/getcases/summary/${state.page}/${state.order}/<%= user; %>`;
  jqxhr = post(url,{q:$("#q").val()},_show_cases_summary);
}
function show_pagination(){
  var url = `/api/v1/cases/getcases/summary/total/<%= user; %>`;
  jqxhr = post(url,{q:$("#q").val()},_show_pagination);
}

/////////////////////// superceded
function show_cases_summarySS(page){
  state.page = page;
  var url = `/api/v1/cases/getcases/summary/${state.page}/${state.order}`;
  jqxhr = get(url,_show_cases_summary);
}
function show_paginationSS(){
  var url = `/api/v1/cases/getcases/summary/total`;
  jqxhr = get(url,_show_pagination);
}
///////////////////////

function _show_pagination(total){
  var items_per_page = 10;
  var total_pages = 1;
  var htmlStr = "Page ";
  
  console.log(total)
  if (total>0){
    total_pages = Math.ceil(Number(total)/items_per_page);
  }
  
  
  for (var i = 0; i < total_pages; i++){
    htmlStr += `<button id="page-${i}" onclick="show_cases_summary(${i})">${i+1}</button>`
  }
  
  $("#cases_pagination").html(htmlStr);
  $(`#cases_pagination button#page-0`).addClass("current");
}
function _show_cases_summary(data){
  console.log(data);
  //json out
  var htmlStr = ""
  $.each(data, function(i,d){
    htmlStr += JSON.stringify(d);
    htmlStr += "<br>";
  });
  $("#cases_debug").html(htmlStr);
  
  //table
  
  
  if (data.length){
    var tableStr = "<div class='stats'><table>"
    //get header assume keys for one applies to the rest
    var header = Object.keys(data[0]);
    tableStr += "<tr>";
    $.each(header, function(i,d){
      if (d == "editor" || d == "caseID"){
        tableStr += "<th class=adjust>";
      }else{
        tableStr += "<th>";
      }
      tableStr += `<span onclick="state.order='${d}';state.order='${d}';show_cases_summary(0)" class="sortBtn">`
      tableStr += d;
      tableStr += ` <img src="/V2/images/down.png" width="20" align="top"></span>`; //need some thoughts on this one
      tableStr += "</th>";
    });
      //additional columns per row of data
      
 
    tableStr += "</tr>";
    
    $.each(data, function(i,d){
      tableStr += "<tr>";
      $.each(d, function(key,val){
        tableStr += "<td>";
        //custom per key
        if (key == "caseID"){
          tableStr += `<a href="/view/case/${val}">${val}</a>`
        }
        else{
          tableStr += `${val}`
        }
         tableStr += "</td>";
      });
      
      //additional columns per row of data



      
      
      tableStr += "</tr>";
    });
    tableStr += "</table>";
    tableStr += "</div>";


    $("#cases").html(tableStr);
  }else{
    $("#cases").html("no records");
  }
  
  //update status message
  $("#cases_status").html("&nbsp;")
  
  //update the pagation class
    $("#cases_pagination button").removeClass("current");
    $(`#cases_pagination button#page-${state.page}`).addClass("current");
}

//show_cases_summary(0);
//show_pagination();

search();
</script>

</body>
</html>


